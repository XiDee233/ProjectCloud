# 基于四叉树的开放世界场景管理系统设计

## 系统概述
实现一个基于四叉树的场景管理系统，用于动态加载和卸载开放世界中的场景，根据玩家位置自动管理场景资源。

## 核心组件

### 1. 四叉树数据结构
- 创建 `QuadtreeNode` 类表示四叉树节点
- 实现 `SceneQuadtree` 类管理场景分区
- 支持场景的添加、移除和查询

### 2. 场景管理组件
- 创建 `SceneQuadtreeManager` 作为核心管理器
- 集成 `PlayerSceneTracker` 监听玩家位置变化
- 与 `PurrNet.ScenesModule` 协作处理网络场景加载/卸载

### 3. 场景数据模型
- 创建 `SceneData` 类存储场景信息（名称、位置、大小、BuildIndex）
- 支持从编辑器配置场景数据

## 实现步骤

1. **创建四叉树基础结构**
   - `QuadtreeNode.cs`: 定义四叉树节点，包含场景列表和子节点
   - `SceneQuadtree.cs`: 实现四叉树的构建、查询和更新方法

2. **实现场景管理核心**
   - `SceneData.cs`: 场景数据模型
   - `SceneQuadtreeManager.cs`: 核心管理器，处理场景加载/卸载逻辑

3. **集成现有系统**
   - 与 `PlayerSceneTracker` 集成，监听玩家位置变化
   - 使用 `PurrNet.ScenesModule` 处理网络场景操作

4. **添加配置支持**
   - 实现编辑器配置界面，方便配置场景信息
   - 支持从配置文件加载场景数据

## 核心功能

- **动态场景加载/卸载**: 根据玩家位置和视距自动加载/卸载场景
- **网络同步**: 利用 PurrNet 确保所有客户端场景状态一致
- **高效查询**: 四叉树结构确保场景查询的高效性
- **支持持久化场景**: 保留 persistent scene，只管理其他场景

## 代码结构

```
Assets/
├── Scripts/
│   ├── SceneManagement/
│   │   ├── Quadtree/
│   │   │   ├── QuadtreeNode.cs
│   │   │   └── SceneQuadtree.cs
│   │   ├── Data/
│   │   │   └── SceneData.cs
│   │   └── Managers/
│   │       └── SceneQuadtreeManager.cs
```

## 实现细节

1. **四叉树构建**: 根据场景大小和位置自动构建四叉树
2. **场景查询**: 当玩家移动时，查询玩家视距范围内的所有场景
3. **场景加载逻辑**: 
   - 比较当前加载的场景和需要加载的场景
   - 卸载不在视距范围内的场景
   - 加载新进入视距范围的场景
4. **网络同步**: 通过 PurrNet.ScenesModule 确保所有客户端场景状态一致

## 预期效果

- 玩家在开放世界中移动时，系统自动加载/卸载周围场景
- 减少内存占用，提高游戏性能
- 平滑的场景过渡，不影响游戏体验
- 所有客户端场景状态保持同步