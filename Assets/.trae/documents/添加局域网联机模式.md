# 添加局域网联机模式实现计划

## 1. 现有系统分析

### 1.1 现有代码结构
- **GameManager.cs**：游戏主管理器，负责初始化和协调各个系统
- **SteamRoomManager.cs**：处理Steam房间管理，包括创建、加入和列表获取
- **PurrNet框架**：负责实际的网络传输，支持多种传输层

### 1.2 现有Steam联机流程
1. 玩家连接到Steam
2. 创建或加入Steam Lobby
3. 设置SteamTransport的P2P模式和地址
4. 启动服务器和客户端

### 1.3 局域网联机需求
- 需要一个局域网房间管理器，类似于SteamRoomManager
- 需要使用UDPTransport代替SteamTransport
- 需要支持本地IP检测和端口转发
- 需要支持局域网内房间发现和加入

## 2. 实现方案

### 2.1 核心组件设计

#### 2.1.1 LocalRoomManager.cs
- 负责局域网房间的创建、发现和加入
- 支持UDP广播进行房间发现
- 管理房间列表和玩家信息
- 提供与SteamRoomManager类似的API

#### 2.1.2 修改GameManager.cs
- 添加局域网模式支持
- 允许切换Steam和局域网模式
- 提供统一的房间管理接口

#### 2.1.3 传输层配置
- 使用现有UDPTransport进行局域网通信
- 支持自动IP检测和端口配置
- 提供可靠的连接机制

### 2.2 实现细节

#### 2.2.1 房间发现机制
- 使用UDP广播进行房间发现
- 定期发送房间信息到局域网
- 监听并收集可用房间列表

#### 2.2.2 房间创建流程
1. 创建UDP服务器
2. 广播房间信息
3. 等待其他玩家加入

#### 2.2.3 房间加入流程
1. 搜索局域网内的房间
2. 选择目标房间
3. 连接到房间主机
4. 启动客户端

#### 2.2.4 统一API设计
```csharp
// GameManager统一接口
public void StartGame(bool useSteam = true)
public void CreateGameRoom(string roomName, int maxPlayers = 10)
public void JoinGameRoom(string roomId)
public void GetAvailableRooms()
```

## 3. 具体实现步骤

### 3.1 创建LocalRoomManager.cs
- 实现局域网房间管理功能
- 支持UDP广播和房间发现
- 提供与SteamRoomManager兼容的API

### 3.2 修改GameManager.cs
- 添加LocalRoomManager引用
- 支持Steam和局域网模式切换
- 提供统一的房间管理接口

### 3.3 配置传输层
- 确保UDPTransport正确配置
- 支持自动IP检测
- 配置合适的端口范围

### 3.4 测试和优化
- 测试局域网房间创建和加入功能
- 测试Steam和局域网模式切换
- 优化房间发现和连接速度

## 4. 预期效果

- 玩家可以选择Steam或局域网联机模式
- 局域网模式下可以创建和加入房间
- 支持自动房间发现
- 两种模式可以无缝切换
- 保持现有Steam联机功能不变

## 5. 技术要点

- 使用UDP广播进行房间发现
- 支持多传输层切换
- 提供统一的API接口
- 确保两种模式的兼容性
- 优化局域网连接性能